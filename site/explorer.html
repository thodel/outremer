<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contribute your Knowledge ‚Äî People of the Levante</title>
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* ‚îÄ‚îÄ Intro panel ‚îÄ‚îÄ */
    .intro-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius);
      margin: 1.2rem auto;
      max-width: 960px;
      overflow: hidden;
    }
    .intro-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: .85rem 1.2rem;
      cursor: pointer;
      user-select: none;
    }
    .intro-header h2 { margin: 0; font-size: 1rem; color: var(--accent); }
    .intro-toggle { font-size: .78rem; color: var(--muted); background: none; border: none; cursor: pointer; padding: .2rem .5rem; }
    .intro-body { padding: 0 1.2rem 1.2rem; }

    .intro-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: .9rem;
      margin-bottom: 1.1rem;
    }
    .intro-step {
      display: flex; gap: .65rem; align-items: flex-start;
      background: var(--bg); border-radius: var(--radius);
      padding: .75rem .9rem; border: 1px solid var(--border);
    }
    .step-num {
      flex-shrink: 0;
      width: 1.6rem; height: 1.6rem;
      background: var(--accent); color: #fff;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: .8rem; font-weight: 700;
    }
    .intro-step p { margin: 0; font-size: .85rem; color: var(--text); line-height: 1.6; }

    /* ‚îÄ‚îÄ Scholar name entry ‚îÄ‚îÄ */
    .scholar-entry {
      display: flex; align-items: center; gap: .65rem;
      background: color-mix(in srgb, var(--accent) 6%, var(--surface));
      border: 1px solid color-mix(in srgb, var(--accent) 30%, var(--border));
      border-radius: var(--radius);
      padding: .75rem 1rem;
      flex-wrap: wrap;
    }
    .scholar-entry label { font-size: .88rem; font-weight: 600; color: var(--accent); white-space: nowrap; }
    .scholar-entry input {
      flex: 1; min-width: 160px;
      padding: .45rem .75rem; font-size: .9rem;
      font-family: var(--font); border: 1px solid var(--border);
      border-radius: var(--radius); background: var(--surface); color: var(--text);
    }
    .scholar-entry input:focus { outline: none; border-color: var(--accent); }
    .scholar-saved { font-size: .8rem; color: #166534; margin-left: .3rem; display: none; }

    /* ‚îÄ‚îÄ Document selector ‚îÄ‚îÄ */
    .doc-selector-row {
      display: flex; gap: .6rem; align-items: center; flex-wrap: wrap;
    }
    #docSelect {
      flex: 1; min-width: 200px;
      padding: .55rem .8rem; font-size: .9rem;
      font-family: var(--font); border: 1px solid var(--border);
      border-radius: var(--radius); background: var(--surface); color: var(--text);
      cursor: pointer;
    }
    #docSelect:focus { outline: none; border-color: var(--accent); }

    /* ‚îÄ‚îÄ Entity-level flag buttons ‚îÄ‚îÄ */
    .entity-flags {
      display: flex; gap: .4rem; align-items: center;
      padding: .35rem 0 .5rem;
      border-bottom: 1px dashed var(--border);
      margin-bottom: .5rem;
      font-size: .78rem; color: var(--muted);
    }
    .entity-flags span { margin-right: .2rem; }
    .flag-entity-btn {
      padding: .25rem .65rem; font-size: .76rem;
      border: 1px solid var(--border); border-radius: 20px;
      background: var(--surface); cursor: pointer;
      transition: background .12s, border-color .12s, color .12s;
      font-family: var(--font);
    }
    .flag-entity-btn:hover { border-color: var(--accent); color: var(--accent); }
    .flag-entity-btn.active-not-person { background: #fee2e2; border-color: #dc2626; color: #dc2626; }
    .flag-entity-btn.active-wrong-era  { background: #fef3c7; border-color: #d97706; color: #d97706; }

    /* ‚îÄ‚îÄ Context comparison (date/place/role) ‚îÄ‚îÄ */
    .context-comparison {
      margin-top: .5rem;
      padding: .5rem .65rem;
      background: color-mix(in srgb, var(--accent) 4%, var(--bg));
      border-radius: calc(var(--radius) - 2px);
      font-size: .78rem;
      border: 1px solid color-mix(in srgb, var(--accent) 15%, var(--border));
    }
    .context-comparison.wd-context {
      background: color-mix(in srgb, #7c3aed 5%, var(--bg));
      border-color: color-mix(in srgb, #7c3aed 20%, var(--border));
    }
    .context-row {
      display: grid;
      grid-template-columns: 70px 1fr 20px 1fr;
      gap: .35rem;
      align-items: center;
      padding: .2rem 0;
      border-bottom: 1px dashed color-mix(in srgb, var(--accent) 10%, var(--border));
    }
    .context-row:last-child { border-bottom: none; }
    .context-label {
      font-size: .72rem;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
    }
    .context-extracted,
    .context-candidate {
      font-size: .78rem;
      padding: .15rem .4rem;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .context-extracted {
      background: color-mix(in srgb, var(--accent) 10%, var(--surface));
      color: var(--text);
    }
    .context-candidate {
      background: color-mix(in srgb, #7c3aed 10%, var(--surface));
      color: var(--text);
    }
    .context-empty {
      color: var(--muted);
      font-style: italic;
    }
    .context-arrow {
      text-align: center;
      color: var(--muted);
      font-size: .9rem;
    }
    .context-match {
      background: color-mix(in srgb, #16a34a 8%, transparent);
    }
    .context-match .context-extracted,
    .context-match .context-candidate {
      background: color-mix(in srgb, #16a34a 15%, var(--surface));
      color: #166534;
      font-weight: 600;
    }
    .context-mismatch {
      background: color-mix(in srgb, #dc2626 6%, transparent);
    }
    .context-mismatch .context-extracted,
    .context-mismatch .context-candidate {
      background: color-mix(in srgb, #dc2626 12%, var(--surface));
      color: #991b1b;
    }
    .context-partial {
      /* One side has data, other doesn't */
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;">
      <div style="display:flex;align-items:center;gap:.85rem;">
        <img src="./assets/logo.png" alt="People of the Levante" style="width:44px;height:44px;object-fit:contain;border-radius:8px;" />
        <h1 style="margin:0;font-size:1.3rem;font-weight:normal;">People of the Levante</h1>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">üåô</button>
      <div>
        <p class="subtitle">
          <a href="./index.html" style="color:rgba(255,255,255,.7);text-decoration:none;">‚Üê Project</a>
          &nbsp;¬∑&nbsp; Contribute your Knowledge
          &nbsp;¬∑&nbsp; <a href="./people.html" style="color:rgba(255,255,255,.7);text-decoration:none;">üë§ People</a>
          &nbsp;¬∑&nbsp; <a href="./stats.html" style="color:rgba(255,255,255,.7);text-decoration:none;">üìä Stats</a>
          &nbsp;¬∑&nbsp; <a href="./upload.html" style="color:rgba(255,255,255,.7);text-decoration:none;">Contribute a Source</a>
        </p>
      </div>
    </div>
  </header>

  <main>

    <!-- ‚îÄ‚îÄ Intro / How-to panel ‚îÄ‚îÄ -->
    <div class="intro-panel" id="introPanel">
      <div class="intro-header" onclick="toggleIntro()">
        <h2>üìñ How to Contribute your Knowledge</h2>
        <button class="intro-toggle" id="introToggleBtn">Minimise ‚ñ≤</button>
      </div>
      <div class="intro-body" id="introBody">
        <div class="intro-steps">
          <div class="intro-step">
            <span class="step-num">1</span>
            <p><strong>Choose a source document</strong> below. The AI has extracted person mentions from each text and proposed links to our authority file of medieval Levant persons.</p>
          </div>
          <div class="intro-step">
            <span class="step-num">2</span>
            <p><strong>Review each link.</strong> Accept (‚úÖ) if the extracted person matches the authority entry. Reject (‚ùå) if it's wrong. Flag (üö©) if you're unsure.</p>
          </div>
          <div class="intro-step">
            <span class="step-num">3</span>
            <p><strong>Flag bad extractions.</strong> If an extracted entry is not a person at all, or is a modern scholar rather than a medieval figure, use the flag buttons on each card.</p>
          </div>
        </div>
        <!-- Scholar name entry -->
        <div class="scholar-entry">
          <label>üë§ Your name (credited in the dataset):</label>
          <input type="text" id="scholarNameInput" placeholder="e.g. Jane Smith or J.S." maxlength="60" />
          <button class="btn-primary" id="scholarSaveBtn" onclick="saveScholarName()">Save name</button>
          <span class="scholar-saved" id="scholarSaved">‚úì Saved</span>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Document selector ‚îÄ‚îÄ -->
    <section class="panel" id="panel-docs">
      <h2>Source Documents</h2>
      <div class="doc-selector-row">
        <select id="docSelect" title="Choose a source document"></select>
        <button id="loadBtn" class="btn-primary">Load document</button>
      </div>
      <div id="docMeta" class="meta-block" style="margin-top:.6rem;font-size:.88rem;"></div>
    </section>

    <!-- ‚îÄ‚îÄ Links + adjudication ‚îÄ‚îÄ -->
    <section class="panel" id="panel-links">
      <h2>Linking and Normalizing the People of the Levante</h2>

      <div id="statsBar" class="stats-bar hidden">
        <span id="statReviewed"></span>
        <span class="sep">¬∑</span>
        <span id="statAccepted"  class="stat-accepted">‚úÖ <span id="statAcceptedN">0</span> accepted</span>
        <span class="sep">¬∑</span>
        <span id="statRejected"  class="stat-rejected">‚ùå <span id="statRejectedN">0</span> rejected</span>
        <span class="sep">¬∑</span>
        <span id="statFlagged"   class="stat-flagged">üö© <span id="statFlaggedN">0</span> flagged</span>
        <span class="sep">¬∑</span>
        <span style="color:#d97706;">‚äò <span id="statEntityFlagsN">0</span> entity flags</span>
        <button id="exportBtn"       class="btn-small">Export decisions (JSON)</button>
        <button id="exportTeiBtn"    class="btn-small">Export TEI-XML</button>
        <button id="exportJsonLdBtn" class="btn-small">Export JSON-LD</button>
      </div>

      <div id="filterBar" class="filter-bar hidden">
        <span class="filter-label">Show:</span>
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="unreviewed">Unreviewed</button>
        <button class="filter-btn" data-filter="accepted">Accepted</button>
        <button class="filter-btn" data-filter="rejected">Rejected</button>
        <button class="filter-btn" data-filter="flagged">Flagged</button>
        <button class="filter-btn" data-filter="no_match">No match</button>
        <button class="filter-btn conflict-btn" data-filter="conflict">‚ö†Ô∏è Conflicts</button>
      </div>

      <div id="links" class="card-grid"></div>
    </section>

    <!-- ‚îÄ‚îÄ Extracted persons ‚îÄ‚îÄ -->
    <section class="panel" id="panel-persons">
      <h2>Extracted Persons <span id="personCount" class="badge"></span></h2>
      <div id="persons" class="card-grid"></div>
    </section>

    <!-- ‚îÄ‚îÄ Raw JSON ‚îÄ‚îÄ -->
    <section class="panel" id="panel-raw">
      <h2>Raw JSON <button id="toggleRaw" class="btn-small">show</button></h2>
      <pre id="raw" class="mono hidden"></pre>
    </section>
  </main>

  <script type="module" src="./app.js"></script>
  <script>
    // ‚îÄ‚îÄ Intro panel toggle ‚îÄ‚îÄ
    const INTRO_KEY = "outremer_intro_collapsed";
    function toggleIntro() {
      const body = document.getElementById("introBody");
      const btn  = document.getElementById("introToggleBtn");
      const collapsed = body.style.display === "none";
      body.style.display = collapsed ? "" : "none";
      btn.textContent = collapsed ? "Minimise ‚ñ≤" : "Expand ‚ñº";
      localStorage.setItem(INTRO_KEY, collapsed ? "0" : "1");
    }
    // Restore collapsed state
    if (localStorage.getItem(INTRO_KEY) === "1") {
      document.getElementById("introBody").style.display = "none";
      document.getElementById("introToggleBtn").textContent = "Expand ‚ñº";
    }

    // ‚îÄ‚îÄ Scholar name (managed here + synced into app.js via module) ‚îÄ‚îÄ
    const SCHOLAR_KEY = "outremer_scholar_name";
    function loadScholarName() {
      const v = localStorage.getItem(SCHOLAR_KEY) || "";
      document.getElementById("scholarNameInput").value = v;
      return v;
    }
    function saveScholarName() {
      const v = document.getElementById("scholarNameInput").value.trim();
      localStorage.setItem(SCHOLAR_KEY, v);
      const s = document.getElementById("scholarSaved");
      s.style.display = "inline";
      setTimeout(() => s.style.display = "none", 2000);
    }
    // Save on Enter
    document.getElementById("scholarNameInput").addEventListener("keydown", e => {
      if (e.key === "Enter") saveScholarName();
    });
    loadScholarName();
    
    // Theme toggle with localStorage persistence
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      const btn = document.querySelector('.theme-toggle');
      if (btn) btn.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) {
        document.documentElement.setAttribute('data-theme', saved);
        const btn = document.querySelector('.theme-toggle');
        if (btn) btn.textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }
    })();
  </script>
</body>
</html>
