<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contribute a Source ‚Äî People of the Medieval Levant</title>
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .upload-wrap { max-width: 620px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }

    .back-link { font-size: .85rem; color: var(--muted); text-decoration: none; display: inline-block; margin-bottom: 1.5rem; }
    .back-link:hover { color: var(--accent); }

    h1 { font-size: 1.4rem; color: var(--accent); margin-bottom: .4rem; }
    .intro { font-size: .9rem; color: var(--muted); line-height: 1.7; margin-bottom: 1.5rem; }

    .form-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
    }

    .field { margin-bottom: 1.1rem; }
    .field label { display: block; font-size: .85rem; font-weight: bold; margin-bottom: .35rem; color: var(--text); }
    .field .hint  { font-size: .78rem; color: var(--muted); margin-bottom: .4rem; }

    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      width: 100%;
      padding: .45rem .65rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: var(--font);
      font-size: .88rem;
      background: var(--bg);
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
    }

    .file-drop {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      background: #fdfcfa;
      transition: border-color .15s;
    }
    .file-drop:hover, .file-drop.drag-over { border-color: var(--accent); background: var(--accent-lt); }
    .file-drop .drop-icon { font-size: 2rem; margin-bottom: .4rem; }
    .file-drop .drop-text { font-size: .88rem; color: var(--muted); }
    .file-drop .drop-text strong { color: var(--accent); }
    .file-drop input[type="file"] { display: none; }
    #fileInfo { font-size: .82rem; color: var(--accent); margin-top: .5rem; font-family: var(--mono); }

    .rights-box {
      background: #faf7f0;
      border: 1px solid #d4c9a8;
      border-radius: var(--radius);
      padding: 1rem 1.1rem;
      margin-bottom: 1.1rem;
    }
    .rights-box p { font-size: .85rem; line-height: 1.65; color: var(--text); margin-bottom: .75rem; }
    .rights-check { display: flex; align-items: flex-start; gap: .6rem; }
    .rights-check input[type="checkbox"] { flex-shrink: 0; width: 1.1rem; height: 1.1rem; margin-top: .15rem; cursor: pointer; accent-color: var(--accent); }
    .rights-check label { font-size: .85rem; line-height: 1.55; cursor: pointer; }

    #submitBtn {
      width: 100%;
      padding: .75rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-family: var(--font);
      font-size: .95rem;
      cursor: pointer;
    }
    #submitBtn:disabled { opacity: .45; cursor: not-allowed; }
    #submitBtn:not(:disabled):hover { opacity: .88; }

    #statusMsg {
      margin-top: 1rem;
      padding: .8rem 1rem;
      border-radius: var(--radius);
      font-size: .88rem;
      display: none;
    }
    #statusMsg.success { background: var(--high-bg); color: var(--high); border: 1px solid #9ed0b0; }
    #statusMsg.error   { background: var(--low-bg);  color: var(--low);  border: 1px solid #e8bfb0; }
    #statusMsg.loading { background: var(--accent-lt); color: var(--accent); border: 1px solid #d4c9a8; }

    .section-title { font-size: .8rem; font-weight: bold; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; margin-bottom: .75rem; margin-top: 1.25rem; }

    .doi-row { display: flex; gap: .5rem; }
    .doi-row input { flex: 1; }
    .btn-fetch {
      flex-shrink: 0;
      padding: .45rem .9rem;
      background: var(--accent-lt);
      color: var(--accent);
      border: 1px solid #d4c9a8;
      border-radius: var(--radius);
      font-family: var(--font);
      font-size: .85rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-fetch:hover { background: #e8dfc8; }
    .btn-fetch:disabled { opacity: .5; cursor: not-allowed; }

    #doiStatus {
      font-size: .78rem;
      margin-top: .35rem;
      min-height: 1.2em;
    }
    #doiStatus.ok  { color: var(--high); }
    #doiStatus.err { color: var(--low); }
    #doiStatus.loading { color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="header-inner" style="display:flex;align-items:center;gap:.85rem;">
      <a href="./index.html" style="display:inline-flex;flex-shrink:0;"><img src="./assets/logo.png" alt="Outremer" style="width:44px;height:44px;object-fit:contain;border-radius:8px;" /></a>
      <div>
        <h1>Voyagers ‚Üí Outremer</h1>
        <p class="subtitle">
          <a href="./index.html" style="color:rgba(255,255,255,.7);text-decoration:none;">‚Üê Project</a>
          &nbsp;¬∑&nbsp; <a href="./explorer.html" style="color:rgba(255,255,255,.7);text-decoration:none;">Explorer</a>
          &nbsp;¬∑&nbsp; <a href="./people.html" style="color:rgba(255,255,255,.7);text-decoration:none;">üë§ People</a>
          &nbsp;¬∑&nbsp; <a href="./stats.html" style="color:rgba(255,255,255,.7);text-decoration:none;">üìä Stats</a>
          &nbsp;¬∑&nbsp; Contribute a Source
        </p>
      </div>
    </div>
  </header>

  <div class="upload-wrap">
    <div id="mixedContentWarning" style="display:none;background:#fff3cd;border:1px solid #f0c040;border-radius:6px;padding:.9rem 1.1rem;margin-bottom:1.2rem;font-size:.88rem;line-height:1.6;">
      ‚ö†Ô∏è <strong>Upload may be blocked by your browser.</strong><br>
      This page is loaded over <strong>HTTPS</strong>, but the upload server runs on <strong>HTTP</strong>.
      Browsers block this (mixed content policy).<br>
      <strong>Use the direct link instead:</strong>
      <a href="http://194.13.80.183/outremer/upload.html" style="color:#7a5800;font-weight:bold;">http://194.13.80.183/outremer/upload.html</a>
    </div>
    <script>
      if (location.protocol === "https:" && "http://194.13.80.183/webhook/outremer-upload".startsWith("http:")) {
        document.getElementById("mixedContentWarning").style.display = "block";
      }
    </script>
    <h1>Contribute a Source</h1>
    <p class="intro">
      Submit a historical source document for inclusion in the pipeline.
      Uploaded files are reviewed by the project team before processing.
      You will receive a confirmation ID; the team will be in touch if they have questions.
    </p>

    <div class="form-panel">

      <!-- File upload -->
      <div class="field">
        <label>Document <span style="color:var(--low)">*</span></label>
        <div class="drop-hint hint">PDF or plain text, max 50 MB.</div>
        <div class="file-drop" id="fileDrop">
          <div class="drop-icon">üìÑ</div>
          <div class="drop-text"><strong>Click to choose</strong> or drag &amp; drop</div>
          <div id="fileInfo"></div>
          <input type="file" id="fileInput" accept=".pdf,.txt" />
        </div>
      </div>

      <!-- Metadata (optional) -->
      <div class="section-title">Document metadata <span style="font-weight:normal;text-transform:none;">(optional but helpful)</span></div>

      <!-- DOI lookup -->
      <div class="field">
        <label>DOI</label>
        <div class="hint">Enter a DOI and click Fetch to auto-fill the fields below.</div>
        <div class="doi-row">
          <input type="text" id="metaDoi" placeholder="e.g. 10.1234/example or https://doi.org/10.1234/example" />
          <button type="button" id="doiBtn" class="btn-fetch">Fetch</button>
        </div>
        <div id="doiStatus"></div>
      </div>

      <div class="field">
        <label>Title</label>
        <input type="text" id="metaTitle" placeholder="e.g. Historia rerum in partibus transmarinis gestarum" />
      </div>

      <div class="two-col" style="display:grid;grid-template-columns:2fr 1fr;gap:.75rem;">
        <div class="field" style="margin:0">
          <label>Author</label>
          <input type="text" id="metaAuthor" placeholder="e.g. William of Tyre" />
        </div>
        <div class="field" style="margin:0">
          <label>Year / Century</label>
          <input type="text" id="metaYear" placeholder="e.g. 1184" />
        </div>
      </div>

      <div class="field" style="margin-top:1rem">
        <label>Language</label>
        <select id="metaLang">
          <option value="">‚Äî unknown / other ‚Äî</option>
          <option value="la">Latin</option>
          <option value="fr">Old French</option>
          <option value="de">Middle High German</option>
          <option value="ar">Arabic</option>
          <option value="el">Greek</option>
          <option value="he">Hebrew</option>
          <option value="hy">Armenian</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="field">
        <label>Note for the team</label>
        <textarea id="metaNote" rows="2" placeholder="Any context that would help the reviewers (edition, provenance, scope‚Ä¶)"></textarea>
      </div>

      <!-- Rights acknowledgment -->
      <div class="rights-box">
        <p>
          By submitting this file you confirm that you have the right to share it for
          academic research purposes, and that doing so does not violate copyright,
          contractual obligations, or any applicable law.
          Files are used solely for research within the People of the Medieval Levant project
          and will not be redistributed without review.
        </p>
        <div class="rights-check">
          <input type="checkbox" id="rightsCheck" />
          <label for="rightsCheck">
            I confirm that I hold or have obtained the necessary rights to upload this document
            for research purposes. <strong>*</strong>
          </label>
        </div>
      </div>

      <button id="submitBtn" disabled>Submit for review</button>

      <div id="statusMsg"></div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ DOI fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function normaliseDoi(raw) {
      return raw.trim()
        .replace(/^https?:\/\/doi\.org\//i, "")
        .replace(/^doi:\s*/i, "");
    }

    function crossrefUrl(doi) {
      return `https://api.crossref.org/works/${encodeURIComponent(doi)}`;
    }

    function doiStatus(cls, msg) {
      const el = document.getElementById("doiStatus");
      el.className = cls;
      el.textContent = msg;
    }

    document.getElementById("doiBtn").addEventListener("click", async () => {
      const raw = document.getElementById("metaDoi").value;
      const doi = normaliseDoi(raw);
      if (!doi) { doiStatus("err", "Please enter a DOI first."); return; }

      const btn = document.getElementById("doiBtn");
      btn.disabled = true;
      doiStatus("loading", "Fetching from CrossRef‚Ä¶");

      try {
        const res = await fetch(crossrefUrl(doi), {
          headers: { "User-Agent": "outremer-poc/1.0 (mailto:tobias.hodel@unibe.ch)" }
        });
        if (!res.ok) throw new Error(`CrossRef returned ${res.status}`);
        const { message: m } = await res.json();

        // Title ‚Äî CrossRef returns an array
        const title = Array.isArray(m.title) ? m.title[0] : (m.title || "");
        if (title) document.getElementById("metaTitle").value = title;

        // Authors ‚Äî format as "Family, Given; Family, Given"
        if (m.author && m.author.length) {
          const authors = m.author.map(a => {
            if (a.family && a.given) return `${a.family}, ${a.given}`;
            return a.family || a.given || a.name || "";
          }).filter(Boolean).join("; ");
          document.getElementById("metaAuthor").value = authors;
        }

        // Year ‚Äî prefer print, then online, then deposited
        const yearSrc = m["published-print"] || m["published-online"] || m.deposited;
        if (yearSrc?.["date-parts"]?.[0]?.[0]) {
          document.getElementById("metaYear").value = yearSrc["date-parts"][0][0];
        }

        // Language
        if (m.language) {
          const sel = document.getElementById("metaLang");
          const opt = [...sel.options].find(o => o.value === m.language);
          if (opt) sel.value = m.language;
        }

        // Normalise the DOI field to clean form
        document.getElementById("metaDoi").value = doi;

        doiStatus("ok", `‚úì Metadata fetched from CrossRef. Check the fields and adjust if needed.`);
      } catch (err) {
        doiStatus("err", `Could not fetch: ${err.message}. Fill in fields manually.`);
      } finally {
        btn.disabled = false;
      }
    });

    // Also trigger fetch on Enter in the DOI field
    document.getElementById("metaDoi").addEventListener("keydown", e => {
      if (e.key === "Enter") { e.preventDefault(); document.getElementById("doiBtn").click(); }
    });

    // ‚îÄ‚îÄ Upload endpoint ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Caddy proxies /webhook/* ‚Üí Flask on port 5111
    const UPLOAD_URL = "http://194.13.80.183/webhook/outremer-upload";

    // ‚îÄ‚îÄ File drop zone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const fileDrop  = document.getElementById("fileDrop");
    const fileInput = document.getElementById("fileInput");
    const fileInfo  = document.getElementById("fileInfo");
    const rightsCheck = document.getElementById("rightsCheck");
    const submitBtn   = document.getElementById("submitBtn");
    const statusMsg   = document.getElementById("statusMsg");

    let selectedFile = null;

    function updateSubmitState() {
      submitBtn.disabled = !(selectedFile && rightsCheck.checked);
    }

    function showFile(file) {
      selectedFile = file;
      const kb = (file.size / 1024).toFixed(1);
      fileInfo.textContent = `${file.name}  (${kb} KB)`;
      updateSubmitState();
    }

    fileDrop.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => {
      if (fileInput.files[0]) showFile(fileInput.files[0]);
    });

    fileDrop.addEventListener("dragover", e => { e.preventDefault(); fileDrop.classList.add("drag-over"); });
    fileDrop.addEventListener("dragleave", () => fileDrop.classList.remove("drag-over"));
    fileDrop.addEventListener("drop", e => {
      e.preventDefault();
      fileDrop.classList.remove("drag-over");
      if (e.dataTransfer.files[0]) showFile(e.dataTransfer.files[0]);
    });

    rightsCheck.addEventListener("change", updateSubmitState);

    // ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    submitBtn.addEventListener("click", async () => {
      if (!selectedFile || !rightsCheck.checked) return;

      submitBtn.disabled = true;
      showStatus("loading", "Uploading‚Ä¶ please wait.");

      const fd = new FormData();
      fd.append("file",               selectedFile);
      fd.append("rights_acknowledged","true");
      fd.append("doi",     normaliseDoi(document.getElementById("metaDoi").value));
      fd.append("title",   document.getElementById("metaTitle").value.trim());
      fd.append("author",  document.getElementById("metaAuthor").value.trim());
      fd.append("year",    document.getElementById("metaYear").value.trim());
      fd.append("language",document.getElementById("metaLang").value);
      fd.append("note",    document.getElementById("metaNote").value.trim());

      try {
        const res = await fetch(UPLOAD_URL, { method: "POST", body: fd });
        const json = await res.json();

        if (res.ok) {
          showStatus("success",
            `‚úÖ Received! Your confirmation ID is <strong>${json.id}</strong>. ` +
            `The project team will review your submission and you will be notified of the outcome.`);
        } else {
          showStatus("error", `‚ùå ${json.error || "Upload failed. Please try again."}`);
          submitBtn.disabled = false;
        }
      } catch (err) {
        const isMixedContent = location.protocol === "https:" && UPLOAD_URL.startsWith("http:");
        let msg = `‚ùå <strong>Could not reach the upload server.</strong><br>`;
        if (isMixedContent) {
          msg += `Your browser blocked the request because this page is served over <strong>HTTPS</strong> but the upload endpoint is <strong>HTTP</strong> (mixed content).<br><br>`;
          msg += `<strong>Workaround:</strong> Open the upload page directly over HTTP: `;
          msg += `<a href="http://194.13.80.183/outremer/upload.html" style="color:var(--accent)">http://194.13.80.183/outremer/upload.html</a>`;
        } else {
          msg += `The server may be temporarily unavailable. `;
          msg += `<details style="margin-top:.5rem"><summary style="cursor:pointer;font-size:.85rem">Technical details</summary>`;
          msg += `<code style="font-size:.8rem">${err.message}</code></details>`;
        }
        showStatus("error", msg);
        submitBtn.disabled = false;
      }
    });

    function showStatus(type, html) {
      statusMsg.className = type;
      statusMsg.innerHTML = html;
      statusMsg.style.display = "block";
    }
  </script>
</body>
</html>
